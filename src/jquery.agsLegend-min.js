var i;(function(h){var x,p,w,c,j;function k(z){if(window.console&&window.console.log){window.console.log("$.agsLegend: "+z)}}function y(z){k("got the templates");w=document.createElement("script");w.style.display="none";w.type="text/x-jquery-tmpl";w.id=p.templateDOMId;w.text=z;h("head").append(w)}function m(){h.ajax({url:p.templateFileURL,success:p.onTemplateLoaded||y})}function l(z){h(z).click(function(A){c=h(A.target);if(c.is("h3")){c.next().slideToggle("slow");c.toggleClass("agsLegendOpen").toggleClass("agsLegendClosed")}})}function o(z){return(/ImageServer/i).test(z.url)}function a(z){return z.tileInfo}function n(z){return(/FeatureServer/i).test(z.url)}function b(z,A,B){j=z.visibleLayers;if(B&&j.indexOf(A)===-1){j.push(A)}else{if(!B&&j.indexOf(A)>-1){j=h.grep(j,function(C){return C!==A})}}if(j.length>0){z.setVisibility(true);z.setVisibleLayers(j)}else{z.setVisibility(false)}}function f(F){var B=F.name.replace(/\s+/g,"_"),E="symbol_"+B,z='<div style="float:left" id="'+E+'"><span id="label_'+B+'">'+F.name+"</span></div>",A=F.drawingInfo.renderer.symbol,C=A.color,D=A.size+10;h("#"+E).livequery(function(G){h("#"+E).expire();var K=Raphael("symbol_"+B,30,D),L=K.circle(20,D/2,D-10),J="rgba("+C[0]+","+C[1]+","+C[2]+","+C[3]+")",H=A.outline.color,I="rgba("+H[0]+","+H[1]+","+H[2]+","+H[3]+")";L.attr({fill:J,stroke:I,"stroke-width":A.outline.width})});return z}function e(A){if(A===null){A=[0,0,0,0]}var B=(h.support.opacity)?"rgba":"rgb",z=(!h.support.opacity)?A[0]+","+A[1]+","+A[2]:A[0]+","+A[1]+","+A[2]+","+A[3];return B+"("+z+")"}function t(A){if(A.width===0){return"none"}var z=(A.width<1)?1:A.width;return z+"px solid "+e(A.color)}function r(){return(this.data.defaultVisibility)?"checked":""}function g(){var z=this.serviceName();if(z===undefined){return"na"}return z.replace(/\s/g,"_")+"_toggle"}function d(z){h("#"+p.templateDOMId).tmpl((z),{drawCircle:f,getColor:e,getBorder:t,getChecked:r,getCheckboxID:g}).prependTo($this)}function u(A){var z=/([a-z_0-9-]*)\/(FeatureServer|ImageServer|MapServer)/i.exec(A);return z[1]}function s(z,A){z+="?f=json&callback=?";h.getJSON(z,function(B){h("#"+p.templateDOMId).tmpl(B,{drawCircle:f,getColor:e,getBorder:t,getChecked:r,getCheckboxID:g,isTiled:function(){return A.hasOwnProperty("tileInfo")},serviceName:function(){return(u(A.url))}}).prependTo($this)})}function v(A){k("addLayer: "+A.id);var B=h(this),z;if(A.id==="layer0"&&p.ignoreBasemaps){return}z=A.url;if(A.version>10){z+="/legend"}else{if(!o(A)&&!n(A)){z+="/layers"}}s(z,A)}function q(C){var z=(/([a-zA-Z0-9_-]*)_toggle/).exec(this.id)[1],D=h(this).attr("checked"),B=h.merge([],x.layerIds),A;h.merge(B,x.graphicsLayerIds);h.each(B,function(F,E){if(E==="layer0"&&p.ignoreBasemaps){return}A=x.getLayer(E);if(u(A.url)===z){A.setVisibility(D)}return;if(A.layerInfos){h.each(A.layerInfos,function(H,G){if(G.name.replace(/\s/g,"_")===z){if(a(A)){A.setVisibility(D)}else{b(A,H,D)}}})}else{if(A.name.replace(/\s/g,"_")===z){A.setVisibility(D)}}})}h.fn.agsLegend=function(z){p=h.extend({},h.fn.agsLegend.defaults,z);if(p.autoLoadTemplates){m()}return this.each(function(){try{$this=h(this);x=p.map;dojo.connect(x,"onLayerAdd",v);$this.delegate("input[type='checkbox']","click",q);if(p.isCollapsible){l(this)}k("Successfully initialized")}catch(A){k("ERROR: "+A.messsage)}})};h.fn.agsLegend.defaults={ignoreBasemaps:true,autoLoadTemplates:false,templateFileURL:"templates.txt",onTemplateLoaded:null,isCollapsible:true,templateDOMId:"layerTemplate"}}(jQuery));if(!Array.indexOf){Array.prototype.indexOf=function(a,b){for(i=(b||0);i<this.length;i++){if(this[i]===a){return i}}return -1}};

